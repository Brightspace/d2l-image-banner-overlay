<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../../d2l-ajax/d2l-ajax.html">
<link rel="import" href="../../d2l-colors/d2l-colors.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown.html">
<link rel="import" href="../../d2l-dropdown/d2l-dropdown-menu.html">
<link rel="import" href="../../d2l-siren-parser/d2l-siren-parser.html">
<link rel="import" href="../../d2l-typography/d2l-typography.html">
<link rel="import" href="../../d2l-typography/d2l-typography-shared-styles.html">
<link rel="import" href="localize-behavior.html">

<dom-module id="d2l-image-banner-overlay">
	<template>
		<style include="d2l-typography d2l-typography-shared-styles">
			:host {
				position: absolute;
				height: 100%;
				width: 100%;
				top: 0;
				left: 0;
				z-index: 1;
				@apply(--d2l-body-standard-text);
				word-wrap: break-word;
			}

			.d2l-image-banner-overlay-content {
				opacity: 0;
				width: 100%;
				height: 100%;
			}

			.d2l-image-banner-overlay-content-shown {
				animation-name: shown;
				animation-duration: 0.5s;
				animation-fill-mode: forwards;
			}

			@keyframes shown {
				0% { opacity: 0 }
				100% { opacity: 1; }
			}

			.d2l-image-banner-course-name {
				position: absolute;
				bottom: 0;
				width: 100%;
				background: linear-gradient(rgba(0, 0, 0, 0), black 200px);
				padding-top: 3.35rem;
				max-height: 100%;
				transform: scale3d(1,1,1);
			}

			#courseName {
				color: var(--d2l-color-white);
				margin-top: 0;
				box-sizing: border-box;
				-webkit-line-clamp: 2;
				-webkit-box-orient: vertical;
				display: -webkit-box;
				overflow: hidden;
				pointer-events: none;
				padding-top: 0;
				padding-bottom: 0;
			}

			d2l-dropdown,
			#courseName {
				margin-left: 2.439%;
				margin-right: 2.439%;
			}

			@media (max-width: 615px) {
				d2l-dropdown,
				#courseName {
					margin-left: 15px;
					margin-right: 15px;
				}
			}

			d2l-dropdown {
				right: 0;
				position: absolute;
				padding-top: 15px;
				padding-bottom: 0;
			}

			[dir='rtl'] d2l-dropdown {
				left: 0;
			}

			d2l-dropdown > button {
				color: #fff;
				background: rgba(0,0,0,.5);
				border: none;
				border-radius: 5px;
				float: left;
				transition: color .5s,background .5s;
				cursor: pointer;
				width: 35px;
				height: 35px;
			}

			d2l-dropdown > button:hover,
			d2l-dropdown > button:focus {
				color: rgba(255,255,255,1);
			    background: #006fbf;
			}

			.elipsis-icon {
				color: inherit;
			}
		</style>

		<d2l-ajax auto
			url="[[organizationUrl]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onOrganizationResponse">
		</d2l-ajax>

		<d2l-ajax
			id="remove-ajax"
			method="PUT"
			body="[[_showBannerAjax]]"
			contentType="application/x-www-form-urlencoded"
			url="[[_removeBannerAction]]"
			headers='{ "Accept": "application/vnd.siren+json" }'
			on-iron-ajax-response="_onRemoveBannerResponse">
		</d2l-ajax>

		<div id="overlayContent" class="d2l-image-banner-overlay-content d2l-typography">
			<div class="d2l-image-banner-course-name">
				<h1 id="courseName" class="d2l-heading-1">[[_courseName]]</h1>
			</div>
			<d2l-dropdown>
				<button	class="menu-item no-tap-interaction d2l-dropdown-opener" aria-label$="[[localize('bannerSettings')]]">
					<d2l-icon class="elipsis-icon" icon="d2l-tier1:more"></d2l-icon>
				</button>
				<d2l-dropdown-menu id="overflow-dropdown">
					<d2l-menu label$="[[localize('bannerSettings')]]">
						<template is="dom-if" if="{{_removeBannerAction}}" restamp="true">
							<d2l-menu-item id="opt-out-button"
								text="[[localize('removeBanner')]]"
								on-d2l-menu-item-select="_optOutOfCourseBanner">
							</d2l-menu-item>
						</template>
					</d2l-menu>
				</d2l-dropdown-menu>
			</d2l-dropdown>
		</div>
	</template>
	<script>
		'use strict';
		Polymer({
			is: 'd2l-image-banner-overlay',
			properties: {
				organizationUrl: String,
				_courseName: String,
				_parser: Object,
				_removeBannerAction: Function,
				_addBannerAction: Function,
				_showBannerAjax: String
			},
			behaviors: [
				window.D2L.ImageBanner.LocalizeBehavior
			],
			ready: function() {
				Polymer.dom(this.$.overlayContent).classList.add('d2l-image-banner-overlay-content-shown');
			},
			_getParser: function() {
				if (!this._parser) {
					this._parser = document.createElement('d2l-siren-parser');
				}
				return this._parser;
			},
			_onOrganizationResponse: function(response) {
				if (response.detail.status === 200) {
					var organization = this._getParser().parse(response.detail.xhr.response);
					if (organization && organization.properties) {
						this._courseName = organization.properties.name;
					}

					this._removeBannerAction = (organization.getActionByName('remove-homepage-banner') || {}).href;
					this._showBannerAjax = 'showCourseBanner=false';
				}
			},
			_optOutOfCourseBanner: function() {
				if (this._removeBannerAction) {
					this.$['remove-ajax'].generateRequest();
				}
			},
			_onRemoveBannerResponse: function(response) {
				var organization = this._getParser().parse(response.detail.xhr.response);
				var status = response.detail.xhr.status;
				if (status === 200) {
					this._addBannerAction = (organization.getActionByName('add-homepage-banner') || {}).href;
					this._showBannerAjax = 'showCourseBanner=true';
				}
			}
		});
	</script>
</dom-module>
